services:
  osrm-backend:
    image: osrm/osrm-backend
    container_name: osrm-backend
    volumes:
      - ./data:/data
    command: >
      sh -c "
      if [ ! -f /data/indonesia-latest.osrm ]; then
        osrm-extract -p /opt/car.lua /data/indonesia-latest.osm.pbf && \
        osrm-partition /data/indonesia-latest.osrm && \
        osrm-customize /data/indonesia-latest.osrm;
      fi && \
      osrm-routed --algorithm mld --threads 24 /data/indonesia-latest.osrm
      "
    ports:
      - "3001:5000"
    restart: unless-stopped

  nominatim:
    image: mediagis/nominatim:5.1
    container_name: nominatim
    volumes:
      - ./nominatim-data:/nominatim/data
      - ./pgdata:/var/lib/postgresql/14/main
    environment:
      - PBF_PATH=/nominatim/data/indonesia-latest.osm.pbf
      # - IMPORT_WIKIPEDIA=/nominatim/data/wikimedia-importance-2024-08.csv.gz
      - THREADS=16
      - IMPORT_STYLE=full
    ports:
      - "8086:8080"
    restart: unless-stopped

  osrm-frontend:
    build:
      context: ./frontend-submodule
      dockerfile: docker/Dockerfile
    container_name: osrm-frontend
    environment:
      - OSRM_BACKEND=https://api.biforst.id
      - OSRM_CENTER=-6.2088,106.8456  # Jakarta coordinates
      - OSRM_ZOOM=10
      - OSRM_LANGUAGE=en
      - OSRM_LABEL=Car (fastest)
    ports:
      - "9966:9966"
    depends_on:
      - osrm-backend
    restart: unless-stopped